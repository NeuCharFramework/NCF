# è§¦å‘å™¨ï¼šåªåœ¨æ¨é€åˆ° master åˆ†æ”¯æ—¶è‡ªåŠ¨æ„å»º
trigger:
- master

# PR è§¦å‘ï¼šåªæœ‰ PR åˆ° master åˆ†æ”¯æ—¶æ‰æ„å»º
# é‡è¦ï¼šåªæœ‰å·²åˆå¹¶çš„PRæ‰ä¼šæ‰§è¡Œå®Œæ•´çš„æ„å»ºå’ŒReleaseæµç¨‹
# æœªåˆå¹¶çš„PRä¼šåœ¨ç¬¬ä¸€æ­¥è¢«æ‹¦æˆªå¹¶åœæ­¢æ‰§è¡Œ
pr:
- master

# ä½¿ç”¨è‡ªæ‰˜ç®¡ä»£ç†æ± ï¼ŒåŠ å¿« CI/CD é€Ÿåº¦
pool:
  name: 'SenparcOpenSource'

variables:
  - group: NcfGitHubTokenVariableGroup
  - name: solution
    value: '**/NCF.sln'
  - name: templateBuild
    value: '**/NCF.Template.sln'
  - name: webProject
    value: 'src/back-end/Senparc.Web/Senparc.Web.csproj'
  - name: buildConfiguration
    value: 'Release'
  - name: NUGET_PACKAGES
    value: $(Agent.ToolsDirectory)/nuget/packages
  - name: buildId
    value: '$(Build.BuildId)'

jobs:
- job: BuildAndRelease
  pool:
    name: 'SenparcOpenSource'
  # å…è®¸è„šæœ¬è®¿é—®OAuth tokenä»¥ä¾¿è°ƒç”¨Azure DevOps REST API
  # æ³¨æ„ï¼šéœ€è¦åœ¨Pipelineè®¾ç½®ä¸­å¯ç”¨"Allow scripts to access the OAuth token"é€‰é¡¹
  variables:
    - name: System.AccessToken
      value: $(System.AccessToken)
  steps:
    # ğŸ”’ ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æ„å»ºç±»å‹å’Œæˆæƒ (æ”¯æŒ PR æ„å»ºå’Œåˆå¹¶åæ„å»º)
    - task: PowerShell@2
      displayName: 'ğŸ”’ Check Build Type and Authorization (Critical Gate)'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "========================================"
          Write-Host "ğŸ”’ CRITICAL GATE: BUILD TYPE & AUTH CHECK"
          Write-Host "========================================"
          Write-Host ""
          Write-Host "ğŸ“‹ æ£€æŸ¥æ¡ä»¶ï¼šæ”¯æŒ2ç§æ„å»ºç±»å‹"
          Write-Host "   1. PullRequest: PR æ„å»ºï¼ˆåˆå¹¶å‰ï¼‰"
          Write-Host "   2. IndividualCI: åˆå¹¶åæ„å»ºï¼ˆæ¨é€åˆ° masterï¼‰"
          Write-Host ""
          
          $buildReason = "$(Build.Reason)"
          $sourceBranch = "$(Build.SourceBranch)"
          
          Write-Host "=== æ„å»ºä¿¡æ¯ ==="
          Write-Host "Build.Reason: $buildReason"
          Write-Host "Build.SourceBranch: $sourceBranch"
          Write-Host ""
          
          # æ£€æŸ¥æ„å»ºç±»å‹ï¼šæ”¯æŒ PullRequest æˆ– IndividualCI (masteråˆ†æ”¯)
          if ($buildReason -eq "PullRequest") {
              Write-Host "ğŸ” æ£€æµ‹åˆ° PR æ„å»ºï¼Œå‡†å¤‡æ£€æŸ¥ GitHub PR çŠ¶æ€..."
              # å¯¹äº PR æ„å»ºï¼Œç»§ç»­åŸæœ‰çš„ GitHub API æ£€æŸ¥é€»è¾‘
          } elseif ($buildReason -eq "IndividualCI" -and $sourceBranch -eq "refs/heads/master") {
              Write-Host "âœ… æ£€æµ‹åˆ° master åˆ†æ”¯çš„åˆå¹¶åæ„å»º"
              Write-Host "   è¿™æ˜¯ PR åˆå¹¶åè§¦å‘çš„æ„å»ºï¼Œå…è®¸ç»§ç»­"
              Write-Host ""
              Write-Host "âœ¨ è·³è¿‡ PR çŠ¶æ€æ£€æŸ¥ï¼Œç›´æ¥è¿›å…¥æ„å»ºæµç¨‹..."
              Write-Host "========================================"
              return  # ç›´æ¥é€šè¿‡ï¼Œä¸éœ€è¦é¢å¤–æ£€æŸ¥
          } else {
              Write-Host "âŒ GATE FAILED: ä¸æ”¯æŒçš„æ„å»ºç±»å‹"
              Write-Host "   Build.Reason: $buildReason"
              Write-Host "   Build.SourceBranch: $sourceBranch"
              Write-Host "   æ”¯æŒçš„ç±»å‹:"
              Write-Host "   - PullRequest (ä»»ä½•ç›®æ ‡åˆ†æ”¯çš„ PR)"
              Write-Host "   - IndividualCI + refs/heads/master (åˆå¹¶åˆ° master åçš„æ„å»º)"
              Write-Host ""
              Write-Host "ğŸš« åœæ­¢æ‰§è¡Œï¼šåªå…è®¸æ”¯æŒçš„æ„å»ºç±»å‹"
              Write-Host "##vso[task.logissue type=error]Pipeline stopped: Unsupported build type"
              Write-Host "##vso[task.complete result=Failed]"
              exit 1
          }
          
          # æ£€æŸ¥PR IDæ˜¯å¦å­˜åœ¨
          $prId = $env:SYSTEM_PULLREQUEST_PULLREQUESTID
          if ([string]::IsNullOrEmpty($prId)) {
              Write-Host "âŒ GATE FAILED: æ— æ³•è·å–PR ID"
              Write-Host "   SYSTEM_PULLREQUEST_PULLREQUESTID: '$prId'"
              Write-Host ""
              Write-Host "ğŸš« åœæ­¢æ‰§è¡Œï¼šPRä¿¡æ¯ä¸å®Œæ•´"
              Write-Host "##vso[task.logissue type=error]Pipeline stopped: PR ID not available"
              Write-Host "##vso[task.complete result=Failed]"
              exit 1
          }
          
          Write-Host "âœ… åŸºç¡€æ£€æŸ¥é€šè¿‡ï¼š"
          Write-Host "   âœ“ è¿™æ˜¯ä¸€ä¸ªPRæ„å»º"
          Write-Host "   âœ“ PR ID: $prId"
          Write-Host ""
          
          # ä½¿ç”¨GitHub REST APIæ£€æŸ¥PRçŠ¶æ€ (å› ä¸ºä»£ç æ‰˜ç®¡åœ¨GitHubï¼Œä¸æ˜¯Azure DevOps)
          Write-Host "ğŸ” æ­£åœ¨æ£€æŸ¥GitHub PRåˆå¹¶çŠ¶æ€..."
          try {
              # è·å–GitHub PRç¼–å· (ä¸åŒäºAzure DevOps PR ID)
              $githubPrNumber = $env:SYSTEM_PULLREQUEST_PULLREQUESTNUMBER
              if ([string]::IsNullOrEmpty($githubPrNumber)) {
                  Write-Host "âŒ GATE FAILED: æ— æ³•è·å–GitHub PRç¼–å·"
                  Write-Host "   SYSTEM_PULLREQUEST_PULLREQUESTNUMBER: '$githubPrNumber'"
                  Write-Host ""
                  Write-Host "ğŸš« åœæ­¢æ‰§è¡Œï¼šGitHub PRä¿¡æ¯ä¸å®Œæ•´"
                  Write-Host "##vso[task.logissue type=error]Pipeline stopped: GitHub PR number not available"
                  Write-Host "##vso[task.complete result=Failed]"
                  exit 1
              }
              
              # GitHub APIç«¯ç‚¹
              $apiUrl = "https://api.github.com/repos/NeuCharFramework/NCF/pulls/$githubPrNumber"
              Write-Host "   GitHub API URL: $apiUrl"
              Write-Host "   GitHub PR Number: $githubPrNumber"
              
              $headers = @{
                  "Authorization" = "token $($env:GH_TOKEN)"
                  "Accept" = "application/vnd.github.v3+json"
                  "User-Agent" = "Azure-DevOps-Pipeline"
              }
              
              $response = Invoke-RestMethod -Uri $apiUrl -Headers $headers -Method GET
              
              $prState = $response.state
              $prMerged = $response.merged
              $prTitle = $response.title
              $prMergedAt = $response.merged_at
              
              Write-Host ""
              Write-Host "ğŸ“Š GitHub PRè¯¦ç»†ä¿¡æ¯ï¼š"
              Write-Host "   PRæ ‡é¢˜: '$prTitle'"
              Write-Host "   PRçŠ¶æ€: '$prState'"
              Write-Host "   æ˜¯å¦å·²åˆå¹¶: $prMerged"
              if ($prMergedAt) {
                  Write-Host "   åˆå¹¶æ—¶é—´: $prMergedAt"
              }
              Write-Host ""
              
              # æ£€æŸ¥PRæ˜¯å¦å·²å…³é—­å¹¶æˆåŠŸåˆå¹¶
              if ($prState -ne "closed") {
                  Write-Host "âŒ GATE FAILED: PRå°šæœªå…³é—­"
                  Write-Host "   å½“å‰çŠ¶æ€: '$prState'"
                  Write-Host "   è¦æ±‚çŠ¶æ€: 'closed'"
                  Write-Host ""
                  Write-Host "ğŸš« åœæ­¢æ‰§è¡Œï¼šåªæœ‰å·²å…³é—­çš„PRæ‰èƒ½è§¦å‘Releaseæ„å»º"
                  Write-Host "   è¯·ç­‰å¾…PRè¢«åˆå¹¶åå†é‡æ–°è§¦å‘æ„å»º"
                  Write-Host "##vso[task.logissue type=error]Pipeline stopped: PR is not closed"
                  Write-Host "##vso[task.complete result=Failed]"
                  exit 1
              }
              
              if (-not $prMerged) {
                  Write-Host "âŒ GATE FAILED: PRå·²å…³é—­ä½†æœªåˆå¹¶"
                  Write-Host "   PRçŠ¶æ€: closed"
                  Write-Host "   åˆå¹¶çŠ¶æ€: $prMerged"
                  Write-Host ""
                  Write-Host "ğŸš« åœæ­¢æ‰§è¡Œï¼šåªæœ‰æˆåŠŸåˆå¹¶çš„PRæ‰èƒ½è§¦å‘Releaseæ„å»º"
                  Write-Host "   è¯¥PRå¯èƒ½è¢«æ‹’ç»æˆ–æ‰‹åŠ¨å…³é—­ï¼Œè€Œéåˆå¹¶"
                  Write-Host "##vso[task.logissue type=error]Pipeline stopped: PR was closed but not merged"
                  Write-Host "##vso[task.complete result=Failed]"
                  exit 1
              }
              
              Write-Host "ğŸ‰ GitHub PRåˆå¹¶çŠ¶æ€æ£€æŸ¥é€šè¿‡ï¼"
              Write-Host "   âœ… PRçŠ¶æ€: closed"
              Write-Host "   âœ… åˆå¹¶çŠ¶æ€: merged = $prMerged"
              Write-Host "   âœ… åˆå¹¶æ—¶é—´: $prMergedAt"
              Write-Host ""
              Write-Host "âœ¨ å…è®¸ç»§ç»­æ‰§è¡Œæ„å»ºå’ŒReleaseæµç¨‹..."
              Write-Host "========================================"
              
          } catch {
              Write-Host "âŒ GATE FAILED: æ— æ³•æ£€æŸ¥GitHub PRçŠ¶æ€"
              Write-Host "   é”™è¯¯ä¿¡æ¯: $($_.Exception.Message)"
              Write-Host ""
              Write-Host "ğŸ’¡ æ•…éšœæ’é™¤å»ºè®®ï¼š"
              Write-Host "   1. æ£€æŸ¥ GH_TOKEN æ˜¯å¦æ­£ç¡®é…ç½®"
              Write-Host "   2. æ£€æŸ¥ GitHub PRç¼–å·æ˜¯å¦æœ‰æ•ˆ: $githubPrNumber"
              Write-Host "   3. æ£€æŸ¥ç½‘ç»œè¿æ¥åˆ° api.github.com"
              Write-Host ""
              Write-Host "ğŸš« åœæ­¢æ‰§è¡Œï¼šæ— æ³•éªŒè¯PRåˆå¹¶çŠ¶æ€"
              Write-Host "##vso[task.logissue type=error]Pipeline stopped: Cannot verify GitHub PR merge status"
              Write-Host "##vso[task.complete result=Failed]"
              exit 1
          }
      env:
        GH_TOKEN: $(GH_TOKEN)
      # æ”¯æŒä¸¤ç§æ„å»ºç±»å‹ï¼šPRæ„å»º æˆ– masteråˆ†æ”¯çš„åˆå¹¶åæ„å»º
      condition: or(eq(variables['Build.Reason'], 'PullRequest'), and(eq(variables['Build.Reason'], 'IndividualCI'), eq(variables['Build.SourceBranch'], 'refs/heads/master')))

    # ğŸ”§ è®¾ç½®ç‰ˆæœ¬å· (è¯»å– PackageVersion + BuildId)
    - task: PowerShell@2
      displayName: 'Set Version from PackageVersion'
      inputs:
        targetType: 'inline'
        script: |
          # è¯»å– NCF.Template.csproj ä¸­çš„ PackageVersion
          $csprojPath = "src/NCF.Template.csproj"
          
          if (Test-Path $csprojPath) {
              Write-Host "Reading PackageVersion from: $csprojPath"
              [xml]$csproj = Get-Content $csprojPath
              
              # ä½¿ç”¨ XPath é€‰æ‹©ç¬¬ä¸€ä¸ª PackageVersion èŠ‚ç‚¹ï¼Œé¿å…æ•°ç»„é—®é¢˜
              $packageVersionNode = $csproj.SelectSingleNode("//PackageVersion")
              
              if ($packageVersionNode -and $packageVersionNode.InnerText) {
                  $packageVersion = $packageVersionNode.InnerText.Trim()
                  Write-Host "Found PackageVersion: $packageVersion"
                  
                  # æ„å»ºç‰ˆæœ¬å­—ç¬¦ä¸²
                  $buildId = "$(buildId)".Trim()
                  $fullVersion = "v$packageVersion-build$buildId"
                  $fileVersion = "$packageVersion-build$buildId"  # ç”¨äºæ–‡ä»¶åï¼Œä¸å« 'v' å‰ç¼€
                  
                  Write-Host "Debug: packageVersion = '$packageVersion'"
                  Write-Host "Debug: buildId = '$buildId'"
                  Write-Host "Setting full version: $fullVersion"
                  Write-Host "Setting file version: $fileVersion"
                  
                  # è®¾ç½® pipeline å˜é‡ (ä½¿ç”¨ä¸“ç”¨å‰ç¼€é¿å…ä¸ç³»ç»Ÿå˜é‡å†²çª)
                  Write-Host "##vso[task.setvariable variable=githubReleaseTag]$fullVersion"
                  Write-Host "##vso[task.setvariable variable=githubFileVersion]$fileVersion"
                  Write-Host "##vso[task.setvariable variable=ncfPackageVersion]$packageVersion"
                  
                  # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
                  Write-Host ""
                  Write-Host "=== Version Information ==="
                  Write-Host "Build ID: $buildId"
                  Write-Host "Package Version: $packageVersion"
                  Write-Host "Full Version Tag: $fullVersion"
                  Write-Host "File Version: $fileVersion"
                  Write-Host "=========================="
              } else {
                  Write-Host "âŒ PackageVersion not found in $csprojPath"
                  # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æ„å»ºID
                  $buildId = "$(buildId)".Trim()
                  $fallbackVersion = "v1.0.0-build$buildId"
                  $fallbackFileVersion = "1.0.0-build$buildId"
                  $fallbackPackageVersion = "1.0.0"
                  
                  Write-Host "Using fallback version: $fallbackVersion"
                  Write-Host "##vso[task.setvariable variable=githubReleaseTag]$fallbackVersion"
                  Write-Host "##vso[task.setvariable variable=githubFileVersion]$fallbackFileVersion"
                  Write-Host "##vso[task.setvariable variable=ncfPackageVersion]$fallbackPackageVersion"
                  
                  # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
                  Write-Host ""
                  Write-Host "=== Version Information (Fallback) ==="
                  Write-Host "Build ID: $buildId"
                  Write-Host "Package Version: $fallbackPackageVersion"
                  Write-Host "Full Version Tag: $fallbackVersion"
                  Write-Host "File Version: $fallbackFileVersion"
                  Write-Host "=========================="
              }
          } else {
              Write-Host "âŒ File not found: $csprojPath"
              # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨æ„å»ºID
              $buildId = "$(buildId)".Trim()
              $fallbackVersion = "v1.0.0-build$buildId"
              $fallbackFileVersion = "1.0.0-build$buildId"
              $fallbackPackageVersion = "1.0.0"
              
              Write-Host "Using fallback version: $fallbackVersion"
              Write-Host "##vso[task.setvariable variable=githubReleaseTag]$fallbackVersion"
              Write-Host "##vso[task.setvariable variable=githubFileVersion]$fallbackFileVersion"
              Write-Host "##vso[task.setvariable variable=ncfPackageVersion]$fallbackPackageVersion"
              
              # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
              Write-Host ""
              Write-Host "=== Version Information (File Not Found) ==="
              Write-Host "Build ID: $buildId"
              Write-Host "Package Version: $fallbackPackageVersion"
              Write-Host "Full Version Tag: $fallbackVersion"
              Write-Host "File Version: $fallbackFileVersion"
              Write-Host "=========================="
          }


    # ğŸ”§ éªŒè¯ GitHub CLI
    - task: PowerShell@2
      displayName: 'Verify GitHub CLI'
      inputs:
        targetType: 'inline'
        script: |
          # å°è¯•å¤šç§æ–¹å¼æŸ¥æ‰¾å’ŒéªŒè¯ GitHub CLI
          try {
              Write-Host "Attempting to verify GitHub CLI installation..."
              
              # æ–¹æ³•1: ç›´æ¥è°ƒç”¨ gh
              $ghVersion = gh --version 2>$null
              if ($ghVersion) {
                  Write-Host "âœ… GitHub CLI found and working:"
                  Write-Host $ghVersion
              } else {
                  throw "Direct gh command failed"
              }
          } catch {
              try {
                  # æ–¹æ³•2: å°è¯•å¸¸è§å®‰è£…è·¯å¾„
                  $commonPaths = @(
                      "${env:ProgramFiles}\GitHub CLI\gh.exe",
                      "${env:ProgramFiles(x86)}\GitHub CLI\gh.exe",
                      "${env:LOCALAPPDATA}\Programs\GitHub CLI\gh.exe",
                      "C:\Program Files\GitHub CLI\gh.exe",
                      "C:\Program Files (x86)\GitHub CLI\gh.exe"
                  )
                  
                  $foundPath = $null
                  foreach ($path in $commonPaths) {
                      if (Test-Path $path) {
                          $foundPath = $path
                          break
                      }
                  }
                  
                  if ($foundPath) {
                      Write-Host "âœ… Found GitHub CLI at: $foundPath"
                      & "$foundPath" --version
                      # æ·»åŠ åˆ° PATH
                      $dirPath = Split-Path $foundPath -Parent
                      Write-Host "##vso[task.setvariable variable=PATH]${env:PATH};$dirPath"
                  } else {
                      Write-Host "âŒ GitHub CLI not found in common locations"
                      Write-Host "Available paths checked:"
                      $commonPaths | ForEach-Object { Write-Host "  - $_" }
                      throw "GitHub CLI not found"
                  }
              } catch {
                  Write-Host "âš ï¸  GitHub CLI verification failed, but continuing..."
                  Write-Host "##vso[task.logissue type=warning]GitHub CLI verification failed but build continues"
              }
          }

    # ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡
    - task: PowerShell@2
      displayName: 'Setup Environment'
      inputs:
        targetType: 'inline'
        script: |
          # è®¾ç½® GitHub token
          $env:GH_TOKEN = "$(GH_TOKEN)"
          Write-Host "##vso[task.setvariable variable=GH_TOKEN;issecret=true]$(GH_TOKEN)"
          
          # éªŒè¯ GitHub è®¤è¯
          gh auth status

          # ===================================================================
      # ğŸš€ å‘å¸ƒæµç¨‹å¼€å§‹ (ç®€åŒ–é€»è¾‘ï¼šæ‰€æœ‰æ£€æŸ¥åœ¨Releaseæ­¥éª¤å†…éƒ¨å®Œæˆ)
      # 1ï¸âƒ£ æ„å»ºä¿¡æ¯é¢„è§ˆ â†’ 2ï¸âƒ£ å¤šå¹³å°æ„å»º â†’ 3ï¸âƒ£ GitHub Release (å†…ç½®æ¡ä»¶æ£€æŸ¥) â†’ 4ï¸âƒ£ NuGet å‘å¸ƒ â†’ 5ï¸âƒ£ Web ç«™ç‚¹å‘å¸ƒ
      # ===================================================================

        # ğŸ” æ„å»ºä¿¡æ¯é¢„è§ˆ (å¿«é€Ÿäº†è§£æ„å»ºä¸Šä¸‹æ–‡)
    - task: PowerShell@2
      name: 'BuildInfo'
      displayName: 'ğŸ” Build Information Preview'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "========================================"
          Write-Host "ğŸ” BUILD INFORMATION PREVIEW"
          Write-Host "========================================"
          Write-Host ""
          
          # æ˜¾ç¤ºåŸºæœ¬æ„å»ºä¿¡æ¯
          $buildReason = $env:BUILD_REASON
          $buildRequestedFor = $env:BUILD_REQUESTEDFOR
          $sourceVersionAuthor = $env:BUILD_SOURCEVERSIONAUTHOR
          
          Write-Host "=== Build Context ==="
          Write-Host "Build.Reason: $buildReason"
          Write-Host "Build.RequestedFor: '$buildRequestedFor'"
          Write-Host "Build.SourceVersionAuthor: '$sourceVersionAuthor'"
          Write-Host "Build.SourceBranch: $env:BUILD_SOURCEBRANCH"
          Write-Host ""
          
          # æ˜¾ç¤ºReleaseç›¸å…³ä¿¡æ¯ï¼ˆä»…ä¾›å‚è€ƒï¼‰
          Write-Host "=== Release Information Preview ==="
          $isAuthorizedUser = ($buildRequestedFor -eq "JeffreySu") -or ($sourceVersionAuthor -eq "JeffreySu")
          Write-Host "Is Authorized for Release: $isAuthorizedUser"
          
          if ($buildReason -eq "PullRequest") {
              $releaseKeyword = $env:SYSTEM_PULLREQUEST_PULLREQUESTTITLE
              Write-Host "PR Title: '$releaseKeyword'"
          } else {
              try {
                  $releaseKeyword = git log -1 --pretty=format:"%s"
                  Write-Host "Latest Commit Message: '$releaseKeyword'"
              } catch {
                  Write-Host "Latest Commit Message: <Could not retrieve>"
              }
          }
          
          if (-not [string]::IsNullOrEmpty($releaseKeyword)) {
              $hasReleaseKeyword = $releaseKeyword.ToLower().Contains("[release]")
              Write-Host "Contains [Release] keyword: $hasReleaseKeyword"
          }
          
          Write-Host ""
          Write-Host "â„¹ï¸  Note: Final release decision will be made in the GitHub Release step"
          Write-Host "========================================"
      env:
        BUILD_REASON: $(Build.Reason)
        BUILD_REQUESTEDFOR: $(Build.RequestedFor)
        BUILD_SOURCEVERSIONAUTHOR: $(Build.SourceVersionAuthor)
        SYSTEM_PULLREQUEST_PULLREQUESTTITLE: $(System.PullRequest.PullRequestTitle)
        BUILD_SOURCEBRANCH: $(Build.SourceBranch)
      # æ”¯æŒä¸¤ç§æ„å»ºç±»å‹ï¼šPRæ„å»º æˆ– masteråˆ†æ”¯çš„åˆå¹¶åæ„å»º
      condition: or(eq(variables['Build.Reason'], 'PullRequest'), and(eq(variables['Build.Reason'], 'IndividualCI'), eq(variables['Build.SourceBranch'], 'refs/heads/master')))

    # ğŸ” è°ƒè¯•æ„å»ºä¿¡æ¯ (æ—©æœŸä¿¡æ¯æ”¶é›†)
    - task: PowerShell@2
      displayName: 'Debug Build Information'
      inputs:
        targetType: 'inline'
        script: |
          # åˆå§‹åŒ–å˜é‡ - åœ¨è„šæœ¬é¡¶éƒ¨å®šä¹‰ä¸€æ¬¡
          $prTitle = $env:SYSTEM_PULLREQUEST_PULLREQUESTTITLE
          $buildRequestedFor = $env:BUILD_REQUESTEDFOR
          $buildRequestedForId = $env:BUILD_REQUESTEDFORID
          $buildRequestedForEmail = $env:BUILD_REQUESTEDFOREMAIL
          $sourceVersionAuthor = $env:BUILD_SOURCEVERSIONAUTHOR
          $isAuthorizedUser = ($buildRequestedFor -eq "JeffreySu") -or ($sourceVersionAuthor -eq "JeffreySu")
          
          # è°ƒè¯•ï¼šæ˜¾ç¤ºæ‰€æœ‰PRç›¸å…³ç¯å¢ƒå˜é‡
          Write-Host ""
          Write-Host "=== PR Environment Variables Debug ==="
          Write-Host "SYSTEM_PULLREQUEST_PULLREQUESTTITLE: '$env:SYSTEM_PULLREQUEST_PULLREQUESTTITLE'"
          Write-Host "SYSTEM_PULLREQUEST_PULLREQUESTID: '$env:SYSTEM_PULLREQUEST_PULLREQUESTID'"
          Write-Host "SYSTEM_PULLREQUEST_PULLREQUESTNUMBER: '$env:SYSTEM_PULLREQUEST_PULLREQUESTNUMBER'"
          Write-Host "SYSTEM_PULLREQUEST_SOURCEBRANCH: '$env:SYSTEM_PULLREQUEST_SOURCEBRANCH'"
          Write-Host "SYSTEM_PULLREQUEST_TARGETBRANCH: '$env:SYSTEM_PULLREQUEST_TARGETBRANCH'"
          Write-Host "BUILD_REASON: '$env:BUILD_REASON'"
          Write-Host "BUILD_SOURCEBRANCH: '$env:BUILD_SOURCEBRANCH'"
          
          Write-Host "=== Build Debug Information ==="
          Write-Host "Build.Reason: $(Build.Reason)"
          Write-Host "Build.SourceBranch: $(Build.SourceBranch)"
          Write-Host "BUILD_REASON: '$env:BUILD_REASON'"
          Write-Host "BUILD_SOURCEBRANCH: '$env:BUILD_SOURCEBRANCH'"
          
          # æ˜¾ç¤ºPRæ ‡é¢˜ - é‡ç”¨é¢„å®šä¹‰çš„å˜é‡
          if ([string]::IsNullOrEmpty($prTitle)) {
              Write-Host "System.PullRequest.PullRequestTitle: <NOT AVAILABLE - Not a PR build>"
          } else {
              Write-Host "System.PullRequest.PullRequestTitle: '$prTitle'"
          }
          
          Write-Host ""
          Write-Host "=== Commit Author Information ==="
          Write-Host "Build.RequestedFor: '$buildRequestedFor'"
          Write-Host "Build.RequestedForId: '$buildRequestedForId'"
          Write-Host "Build.RequestedForEmail: '$buildRequestedForEmail'"
          Write-Host "Build.SourceVersionAuthor: '$sourceVersionAuthor'"
          
          # æ˜¾ç¤ºReleaseæƒé™æ£€æŸ¥ç»“æœ - é‡ç”¨é¢„å®šä¹‰çš„å˜é‡
          Write-Host "Is Authorized for Release: $isAuthorizedUser"
          if ($isAuthorizedUser) {
              Write-Host "âœ… User is authorized to create releases"
          } else {
              Write-Host "âŒ User is NOT authorized to create releases (only JeffreySu can create releases)"
          }
          
          # æ˜¾ç¤ºæ„å»ºé¢„è§ˆç»“æœ
          Write-Host ""
          Write-Host "=== Build Preview Results ==="
          Write-Host "Build information has been displayed in the previous step"
          Write-Host "Final release decision will be made in the GitHub Release step"
          
          Write-Host "=============================="

    # âœ… å¤šå¹³å°æ„å»º (ä¸ºæ½œåœ¨çš„Releaseæˆ–å¸¸è§„ä½¿ç”¨ç”Ÿæˆäº§ç‰©)
    - task: PowerShell@2
      displayName: 'ğŸ”¨ Build Multiple Platforms (Generate All Artifacts)'
      inputs:
        targetType: 'inline'
        script: |
          Write-Host "========================================"
          Write-Host "ğŸ”¨ MULTI-PLATFORM BUILD"
          Write-Host "========================================"
          Write-Host ""
          
          Write-Host "=== Build Strategy ==="
          Write-Host "Building all platforms for potential release or standard use"
          Write-Host ""
          
          Write-Host "ğŸ—ï¸  MULTI-PLATFORM BUILD: æ„å»ºæ‰€æœ‰å¹³å°"
          Write-Host "   Purpose: ç”Ÿæˆå®Œæ•´çš„æ„å»ºäº§ç‰©"
          Write-Host "   Release decision: å°†åœ¨GitHub Releaseæ­¥éª¤ä¸­ç¡®å®š"
          $buildPurpose = "Multi-Platform Artifacts"
          
          Write-Host "Build Purpose: $buildPurpose"
          Write-Host "Target Project: $(webProject)"
          Write-Host "Build Configuration: $(buildConfiguration)"
          Write-Host ""
          
          Write-Host "=== Multi-Platform Publishing ==="
          Write-Host "ğŸ–¥ï¸  Publishing Windows x64 platform..."
          dotnet publish $(webProject) --configuration $(buildConfiguration) --runtime win-x64 --output $(Build.ArtifactStagingDirectory)/win-x64

          Write-Host "ğŸ’» Publishing Windows ARM64 platform (Surface Pro X, etc.)..."
          dotnet publish $(webProject) --configuration $(buildConfiguration) --runtime win-arm64 --output $(Build.ArtifactStagingDirectory)/win-arm64

          Write-Host "ğŸ§ Publishing Linux x64 platform..."
          dotnet publish $(webProject) --configuration $(buildConfiguration) --runtime linux-x64 --output $(Build.ArtifactStagingDirectory)/linux-x64

          Write-Host "ğŸ”§ Publishing Linux ARM64 platform..."
          dotnet publish $(webProject) --configuration $(buildConfiguration) --runtime linux-arm64 --output $(Build.ArtifactStagingDirectory)/linux-arm64

          Write-Host "ğŸ Publishing macOS x64 platform (Intel/Rosetta)..."
          dotnet publish $(webProject) --configuration $(buildConfiguration) --runtime osx-x64 --output $(Build.ArtifactStagingDirectory)/osx-x64

          Write-Host "ğŸš€ Publishing macOS ARM64 platform (Apple Silicon)..."
          dotnet publish $(webProject) --configuration $(buildConfiguration) --runtime osx-arm64 --output $(Build.ArtifactStagingDirectory)/osx-arm64
          
          Write-Host ""
          Write-Host "âœ… All platform builds completed successfully"
          Write-Host "   Output Directory: $(Build.ArtifactStagingDirectory)"
          Write-Host "   Build Purpose: $buildPurpose"
          Write-Host "========================================"

    # ğŸŸ¢ ç¼“å­˜ NuGet åŠä¾èµ–é¡¹
    - task: Cache@2
      inputs:
        key: 'nuget | "$(Agent.OS)" | **/*.csproj'
        path: '$(NUGET_PACKAGES)'
        restoreKeys: 'nuget'
      displayName: 'Cache NuGet Packages'

    # ğŸŸ¢ ç¼“å­˜ Aspire Workload
    - task: Cache@2
      inputs:
        key: 'aspire-workload | "$(Agent.OS)"'
        path: '~/.dotnet'
        restoreKeys: 'aspire-workload'
      displayName: 'Cache Aspire Workload'

    # ğŸŸ¢ ç¼“å­˜ NuGet å·¥å…·
    - task: Cache@2
      inputs:
        key: 'nuget-tool | "$(Agent.OS)"'
        path: 'C:\ProgramData\nuget'
        restoreKeys: 'nuget-tool'
      displayName: 'Cache NuGet Tool'

    # âœ… ä»…å½“ç¼“å­˜æœªå‘½ä¸­æ—¶å®‰è£… Aspire Workload
    - script: |
        dotnet workload list | findstr /C:"aspire" || dotnet workload install aspire
      displayName: 'Check & Install Aspire Workload'
      condition: ne(variables['CACHE_RESTORED'], 'true')

    # âœ… ä½¿ç”¨ç¼“å­˜çš„ NuGet ç‰ˆæœ¬
    - task: NuGetToolInstaller@1
      displayName: 'Use Cached NuGet 6.3.0'
      inputs:
        versionSpec: '6.3.0'

    - script: |
        nuget sources remove -name nuget.org
      displayName: 'Remove Existing NuGet Source'

    - script: |
        dotnet nuget add source https://api.nuget.org/v3/index.json -n nuget.org
      displayName: 'Add NuGet Source'

    # âœ… æ¢å¤ NuGet ä¾èµ–
    - task: NuGetCommand@2
      inputs:
        restoreSolution: '$(solution)'

    # âœ… è§£å†³æ–¹æ¡ˆæ„å»º
    - task: VSBuild@1
      inputs:
        solution: '$(solution)'
        msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:DesktopBuildPackageLocation="$(build.artifactStagingDirectory)\WebApp.zip" /p:DeployIisAppPath="Default Web Site"'
        platform: 'Any CPU'
        configuration: '$(buildConfiguration)'

    # âœ… æ¢å¤ Template ä¾èµ–
    - task: NuGetCommand@2
      inputs:
        restoreSolution: '$(templateBuild)'

    # âœ… æ„å»º Template è§£å†³æ–¹æ¡ˆ
    - task: VSBuild@1
      inputs:
        solution: '$(templateBuild)'
        msbuildArgs: ''
        platform: 'Any CPU'
        configuration: '$(buildConfiguration)'



    # ğŸš€ åˆ›å»º GitHub Release (åŸºäºæ—©æœŸæ£€æŸ¥ç»“æœ)
    - task: PowerShell@2
      displayName: 'ğŸš€ Create GitHub Release (Conditional on Early Check)'
      inputs:
        targetType: 'inline'
        script: |
          try {
              Write-Host "========================================"
              Write-Host "ğŸš€ GITHUB RELEASE CREATION"
              Write-Host "========================================"
              Write-Host ""
              
              # é‡æ–°æ‰§è¡ŒReleaseæ¡ä»¶æ£€æŸ¥ï¼ˆé¿å…Azure DevOpsæ¡ä»¶è¯„ä¼°é—®é¢˜ï¼‰
              Write-Host "=== Release Condition Verification ==="
              
              # 1. ç”¨æˆ·æƒé™æ£€æŸ¥
              $buildReason = $env:BUILD_REASON
              $buildRequestedFor = $env:BUILD_REQUESTEDFOR
              $sourceVersionAuthor = $env:BUILD_SOURCEVERSIONAUTHOR
              $isAuthorizedUser = ($buildRequestedFor -eq "JeffreySu") -or ($sourceVersionAuthor -eq "JeffreySu")
              
              Write-Host "Build.RequestedFor: '$buildRequestedFor'"
              Write-Host "Build.SourceVersionAuthor: '$sourceVersionAuthor'"
              Write-Host "Is Authorized User: $isAuthorizedUser"
              
              if (-not $isAuthorizedUser) {
                  Write-Host ""
                  Write-Host "âŒ AUTHORIZATION FAILED: Only JeffreySu can create releases"
                  Write-Host "   Current user: '$buildRequestedFor' / '$sourceVersionAuthor'"
                  Write-Host "   Required user: 'JeffreySu'"
                  Write-Host ""
                  Write-Host "â­ï¸  SKIPPING GITHUB RELEASE CREATION"
                  Write-Host "â„¹ï¸  Build will continue with other steps (artifacts, NuGet, etc.)"
                  Write-Host "========================================"
                  return
              }
              
              Write-Host "âœ… User authorization passed"
              
              # 2. Releaseå…³é”®å­—æ£€æŸ¥
              Write-Host ""
              Write-Host "=== Release Keyword Check ==="
              if ($buildReason -eq "PullRequest") {
                  $releaseKeyword = $env:SYSTEM_PULLREQUEST_PULLREQUESTTITLE
                  $releaseKeywordSource = "PRæ ‡é¢˜"
              } else {
                  try {
                      $releaseKeyword = git log -1 --pretty=format:"%s"
                      $releaseKeywordSource = "Commit Message"
                  } catch {
                      $releaseKeyword = ""
                      $releaseKeywordSource = "Commit Message"
                  }
              }
              
              Write-Host "${releaseKeywordSource}: '$releaseKeyword'"
              
              if ([string]::IsNullOrEmpty($releaseKeyword)) {
                  Write-Host ""
                  Write-Host "âŒ RELEASE KEYWORD CHECK FAILED: æ— æ³•è·å–${releaseKeywordSource}"
                  Write-Host ""
                  Write-Host "â­ï¸  SKIPPING GITHUB RELEASE CREATION"
                  Write-Host "â„¹ï¸  Build will continue with other steps (artifacts, NuGet, etc.)"
                  Write-Host "========================================"
                  return
              }
              
              if (-not ($releaseKeyword.ToLower().Contains("[release]"))) {
                  Write-Host ""
                  Write-Host "âŒ RELEASE KEYWORD CHECK FAILED: ${releaseKeywordSource} does not contain [Release]"
                  Write-Host "   Current ${releaseKeywordSource}: '$releaseKeyword'"
                  Write-Host "   Required: Must contain '[Release]' (case insensitive)"
                  Write-Host "   Examples: '[Release] v1.0', 'Bug fixes [RELEASE]', '[release] New features'"
                  Write-Host ""
                  Write-Host "â­ï¸  SKIPPING GITHUB RELEASE CREATION"
                  Write-Host "â„¹ï¸  Build will continue with other steps (artifacts, NuGet, etc.)"
                  Write-Host "========================================"
                  return
              }
              
              Write-Host "âœ… ${releaseKeywordSource} contains [Release] keyword"
              
              # 3. æ‰€æœ‰æ¡ä»¶æ»¡è¶³
              Write-Host ""
              Write-Host "ğŸ‰ ALL RELEASE CONDITIONS SATISFIED!"
              Write-Host "   âœ… User: JeffreySu"
              Write-Host "   âœ… Keyword: [Release] found in ${releaseKeywordSource}"
              Write-Host "   âœ… Build Type: $buildReason"
              Write-Host ""
              Write-Host "ğŸš€ Proceeding with GitHub Release creation..."
              Write-Host ""
              Write-Host "=== Release Information ==="
              Write-Host "Release Tag: $(githubReleaseTag)"
              Write-Host "File Version: $(githubFileVersion)"
              Write-Host "Package Version: $(ncfPackageVersion)"
              Write-Host "Build ID: $(buildId)"
              
              Write-Host "Creating GitHub Release version $(githubReleaseTag)"
              
              # ç¡®ä¿ GitHub CLI å¯ç”¨
              try {
                  $ghVersion = gh --version 2>$null
                  if ($ghVersion) {
                      Write-Host "Using GitHub CLI: $ghVersion"
                  } else {
                      throw "GitHub CLI not accessible"
                  }
              } catch {
                  Write-Host "âš ï¸ GitHub CLI not found, attempting to locate..."
                  $commonPaths = @(
                      "${env:ProgramFiles}\GitHub CLI\gh.exe",
                      "${env:ProgramFiles(x86)}\GitHub CLI\gh.exe",
                      "C:\Program Files\GitHub CLI\gh.exe"
                  )
                  
                  $ghPath = $null
                  foreach ($path in $commonPaths) {
                      if (Test-Path $path) {
                          $ghPath = $path
                          break
                      }
                  }
                  
                  if ($ghPath) {
                      Write-Host "Found GitHub CLI at: $ghPath"
                      Set-Alias -Name gh -Value $ghPath -Scope Global
                  } else {
                      throw "GitHub CLI not found in any common location"
                  }
              }
              
              # æ·»åŠ  macOS å¯åŠ¨è„šæœ¬åˆ°å‘å¸ƒåŒ… (è½¬æ¢ä¸ºUnixè¡Œç»“æŸç¬¦)
              Write-Host "Adding macOS startup script to release packages..."
              if (Test-Path "start-ncf-macos.sh") {
                  # è¯»å–æ–‡ä»¶å†…å®¹å¹¶è½¬æ¢è¡Œç»“æŸç¬¦ä¸º LF (Unixæ ¼å¼)
                  $scriptContent = Get-Content "start-ncf-macos.sh" -Raw
                  $unixScript = $scriptContent -replace "`r`n", "`n" -replace "`r", "`n"
                  
                  # å†™å…¥åˆ° macOS å‘å¸ƒç›®å½•ï¼Œç¡®ä¿ä½¿ç”¨ UTF-8 æ—  BOM ç¼–ç 
                  [System.IO.File]::WriteAllText("$(Build.ArtifactStagingDirectory)/osx-x64/start-ncf-macos.sh", $unixScript, [System.Text.UTF8Encoding]::new($false))
                  [System.IO.File]::WriteAllText("$(Build.ArtifactStagingDirectory)/osx-arm64/start-ncf-macos.sh", $unixScript, [System.Text.UTF8Encoding]::new($false))
                  
                  Write-Host "âœ… macOS startup script added with Unix line endings"
              } else {
                  Write-Host "âš ï¸  Warning: start-ncf-macos.sh not found in source directory"
              }

              # æ·»åŠ  macOS ä½¿ç”¨æŒ‡å— (ç¡®ä¿æ­£ç¡®ç¼–ç )
              if (Test-Path "MACOS_USAGE_GUIDE.md") {
                  # è¯»å–æ–‡ä»¶å†…å®¹å¹¶è½¬æ¢è¡Œç»“æŸç¬¦ä¸º LF (Unixæ ¼å¼)
                  $guideContent = Get-Content "MACOS_USAGE_GUIDE.md" -Raw
                  $unixGuide = $guideContent -replace "`r`n", "`n" -replace "`r", "`n"
                  
                  # å†™å…¥åˆ° macOS å‘å¸ƒç›®å½•ï¼Œç¡®ä¿ä½¿ç”¨ UTF-8 æ—  BOM ç¼–ç 
                  [System.IO.File]::WriteAllText("$(Build.ArtifactStagingDirectory)/osx-x64/MACOS_USAGE_GUIDE.md", $unixGuide, [System.Text.UTF8Encoding]::new($false))
                  [System.IO.File]::WriteAllText("$(Build.ArtifactStagingDirectory)/osx-arm64/MACOS_USAGE_GUIDE.md", $unixGuide, [System.Text.UTF8Encoding]::new($false))
                  
                  Write-Host "âœ… macOS usage guide added with Unix line endings"
              }

              # å‹ç¼©å‘å¸ƒæ–‡ä»¶ä»¥å‡å°‘assetæ•°é‡
              Write-Host "Compressing release files..."
              Compress-Archive -Path "$(Build.ArtifactStagingDirectory)/win-x64/*" -DestinationPath "$(Build.ArtifactStagingDirectory)/ncf-win-x64-$(githubFileVersion).zip" -Force
              Compress-Archive -Path "$(Build.ArtifactStagingDirectory)/win-arm64/*" -DestinationPath "$(Build.ArtifactStagingDirectory)/ncf-win-arm64-$(githubFileVersion).zip" -Force
              Compress-Archive -Path "$(Build.ArtifactStagingDirectory)/linux-x64/*" -DestinationPath "$(Build.ArtifactStagingDirectory)/ncf-linux-x64-$(githubFileVersion).zip" -Force
              Compress-Archive -Path "$(Build.ArtifactStagingDirectory)/linux-arm64/*" -DestinationPath "$(Build.ArtifactStagingDirectory)/ncf-linux-arm64-$(githubFileVersion).zip" -Force
              Compress-Archive -Path "$(Build.ArtifactStagingDirectory)/osx-x64/*" -DestinationPath "$(Build.ArtifactStagingDirectory)/ncf-osx-x64-$(githubFileVersion).zip" -Force
              Compress-Archive -Path "$(Build.ArtifactStagingDirectory)/osx-arm64/*" -DestinationPath "$(Build.ArtifactStagingDirectory)/ncf-osx-arm64-$(githubFileVersion).zip" -Force
              
              # éªŒè¯æ–‡ä»¶å­˜åœ¨
              $assetFiles = @(
                  "$(Build.ArtifactStagingDirectory)/ncf-win-x64-$(githubFileVersion).zip",
                  "$(Build.ArtifactStagingDirectory)/ncf-win-arm64-$(githubFileVersion).zip",
                  "$(Build.ArtifactStagingDirectory)/ncf-linux-x64-$(githubFileVersion).zip",
                  "$(Build.ArtifactStagingDirectory)/ncf-linux-arm64-$(githubFileVersion).zip",
                  "$(Build.ArtifactStagingDirectory)/ncf-osx-x64-$(githubFileVersion).zip",
                  "$(Build.ArtifactStagingDirectory)/ncf-osx-arm64-$(githubFileVersion).zip"
              )
              
              foreach ($file in $assetFiles) {
                  if (Test-Path $file) {
                      $size = (Get-Item $file).Length / 1MB
                      Write-Host "âœ… Asset ready: $(Split-Path $file -Leaf) ($([math]::Round($size, 2)) MB)"
                  } else {
                      Write-Host "âŒ Missing asset: $file"
                  }
              }
              
              # åˆ›å»º release
              $releaseNotes = @"
          ## ğŸš€ NCF Release $(githubReleaseTag)
          
          ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
          - **Package Version**: $(ncfPackageVersion)
          - **Build ID**: $(buildId)
          - **Full Version**: $(githubReleaseTag)
          
          ### ğŸ“¦ å¹³å°æ”¯æŒ
          - **Windows x64** - é€‚ç”¨äºä¼ ç»Ÿ Windows 10/11 (Intel/AMD 64ä½)
          - **Windows ARM64** - é€‚ç”¨äº Surface Pro X, Surface Laptop 5/6 ç­‰ ARM æ¶æ„è®¾å¤‡
          - **Linux x64** - é€‚ç”¨äº Linux (Intel/AMD 64ä½)
          - **Linux ARM64** - é€‚ç”¨äº Linux (ARM64ï¼Œå¦‚æ ‘è“æ´¾4+)
          - **macOS x64** - é€‚ç”¨äº Intel Mac æˆ– Apple Silicon Mac (é€šè¿‡ Rosetta 2)
          - **macOS ARM64** - é€‚ç”¨äº Apple Silicon Mac (M1/M2/M3/M4 åŸç”Ÿ)
          
          ### ğŸ“‹ ä½¿ç”¨æŒ‡å—
          **Windows ç”¨æˆ·è¯·æ³¨æ„**ï¼š
          - å¤§éƒ¨åˆ† Windows è®¾å¤‡ä½¿ç”¨ `ncf-win-x64-$(githubFileVersion).zip`
          - Surface Pro X ç­‰ ARM è®¾å¤‡ä½¿ç”¨ `ncf-win-arm64-$(githubFileVersion).zip`
          
          **macOS ç”¨æˆ·è¯·æ³¨æ„**ï¼š
          - M1/M2/M3/M4 Mac ç”¨æˆ·æ¨èä¸‹è½½ `ncf-osx-arm64-$(githubFileVersion).zip` (åŸç”Ÿæ€§èƒ½æ›´å¥½)
          - Intel Mac ç”¨æˆ·ä¸‹è½½ `ncf-osx-x64-$(githubFileVersion).zip`
          - **ğŸ†• è‡ªåŠ¨åŒ–å¯åŠ¨è„šæœ¬**ï¼šåŒ…å«ä¼˜åŒ–çš„ `start-ncf-macos.sh`
            - âœ… è‡ªåŠ¨å¤„ç† macOS å®‰å…¨æƒé™é—®é¢˜
            - âœ… è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ç›®å½•
            - âœ… å·²ä¿®å¤è¡Œç»“æŸç¬¦é—®é¢˜ï¼Œç¡®ä¿åœ¨æ‰€æœ‰ macOS ç‰ˆæœ¬ä¸Šæ­£å¸¸è¿è¡Œ
            - ä¸€é”®å¯åŠ¨ï¼šè§£å‹åè¿è¡Œ `./start-ncf-macos.sh`
          - æ‰‹åŠ¨å¯åŠ¨ï¼š`dotnet Senparc.Web.dll`
          - å®Œæ•´ä½¿ç”¨æŒ‡å—è¯·æŸ¥çœ‹ `MACOS_USAGE_GUIDE.md`
          
          ### ğŸ“… æ„å»ºä¿¡æ¯
          - æ„å»ºå·: $(Build.BuildNumber)
          - æºåˆ†æ”¯: $(Build.SourceBranchName)
          - æäº¤: $(Build.SourceVersion)
          - å‘å¸ƒæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
          - PR æ ‡é¢˜: $env:SYSTEM_PULLREQUEST_PULLREQUESTTITLE
          
          ### ğŸ“‹ å˜æ›´
          æœ¬ç‰ˆæœ¬åŸºäº NCF Template v$(ncfPackageVersion)ï¼Œè¯¦ç»†å˜æ›´è¯·æŸ¥çœ‹ï¼š
          - [PackageReleaseNotes](https://github.com/NeuCharFramework/NCF/blob/master/src/NCF.Template.csproj)
          - [æäº¤å†å²](https://github.com/NeuCharFramework/NCF/commits/$(Build.SourceBranchName))
          
          ---
          
          > **ğŸ“‹ å¼€å‘è€…æç¤º**: æ­¤Releaseé€šè¿‡åŒ…å« `[Release]` æ ‡ç­¾çš„PRè‡ªåŠ¨åˆ›å»ºã€‚
          > è¦åˆ›å»ºæ–°çš„Releaseï¼Œè¯·ç¡®ä¿PRæ ‡é¢˜åŒ…å« `[Release]` (ä¸åŒºåˆ†å¤§å°å†™)ã€‚
          "@
              
              Write-Host "Creating GitHub Release..."
              gh release create "$(githubReleaseTag)" `
                  --target "$(Build.SourceVersion)" `
                  --title "NCF Release $(githubReleaseTag)" `
                  --notes $releaseNotes `
                  "$(Build.ArtifactStagingDirectory)/ncf-win-x64-$(githubFileVersion).zip" `
                  "$(Build.ArtifactStagingDirectory)/ncf-win-arm64-$(githubFileVersion).zip" `
                  "$(Build.ArtifactStagingDirectory)/ncf-linux-x64-$(githubFileVersion).zip" `
                  "$(Build.ArtifactStagingDirectory)/ncf-linux-arm64-$(githubFileVersion).zip" `
                  "$(Build.ArtifactStagingDirectory)/ncf-osx-x64-$(githubFileVersion).zip" `
                  "$(Build.ArtifactStagingDirectory)/ncf-osx-arm64-$(githubFileVersion).zip"
                  
              Write-Host "âœ… GitHub Release created successfully"
          } catch {
              Write-Host "âŒ Failed to create GitHub Release: $_"
              Write-Host "##vso[task.logissue type=warning]GitHub Release creation failed but build continues"
          }
      env:
        GH_TOKEN: $(GH_TOKEN)
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
        BUILD_REASON: $(Build.Reason)
        BUILD_REQUESTEDFOR: $(Build.RequestedFor)
        BUILD_SOURCEVERSIONAUTHOR: $(Build.SourceVersionAuthor)
        SYSTEM_PULLREQUEST_PULLREQUESTTITLE: $(System.PullRequest.PullRequestTitle)
      # ç®€åŒ–æ¡ä»¶ï¼šåªæ£€æŸ¥åŸºæœ¬æ„å»ºç±»å‹ï¼Œå…·ä½“é€»è¾‘åœ¨è„šæœ¬å†…éƒ¨å¤„ç†
      # è¿™æ ·é¿å…Azure DevOpsæ¡ä»¶è¯„ä¼°çš„å¤æ‚æ€§é—®é¢˜
      condition: and(succeeded(), or(eq(variables['Build.Reason'], 'PullRequest'), and(eq(variables['Build.Reason'], 'IndividualCI'), eq(variables['Build.SourceBranch'], 'refs/heads/master'))))

    # âœ… æ¨é€ NuGet åŒ… (å‘å¸ƒæµç¨‹ç¬¬3æ­¥ï¼šåœ¨ GitHub Release ä¹‹åæ‰§è¡Œ)
    - task: NuGetCommand@2
      displayName: 'ğŸ“¦ Push NuGet Package (Step 3)'
      inputs:
        command: push
        packagesToPush: '**/Senparc.NCF.Template.*.nupkg'
        nuGetFeedType: external
        publishFeedCredentials: 'nuget-jeffrey-full-key'
      continueOnError: true
      condition: succeededOrFailed()

    # âœ… å‘å¸ƒæ„å»ºäº§ç‰© (å‘å¸ƒæµç¨‹ç¬¬4æ­¥ï¼šWeb ç«™ç‚¹å‘å¸ƒ - æœ€ç»ˆæ­¥éª¤)
    - task: PublishBuildArtifacts@1
      displayName: 'ğŸŒ Publish Web Artifacts (Step 4 - Final)'
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'sample'