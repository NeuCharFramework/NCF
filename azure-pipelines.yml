trigger:
- master

# ğŸ¯ ä½¿ç”¨è‡ªæ‰˜ç®¡ä»£ç†æ± ï¼ŒåŠ å¿« CI/CD é€Ÿåº¦
pool:
  name: 'SenparcOpenSource'  # è¿™é‡Œå¡«ä½ çš„è‡ªæ‰˜ç®¡ Agent Pool åç§°
  demands:
    - Agent.OS -equals Windows_NT

variables:
  solution: '**/NCF.sln'
  templateBuild: '**/NCF.Template.sln'
  webProject: '**/Senparc.Web/Senparc.Web.csproj'
  buildConfiguration: 'Release'
  NUGET_PACKAGES: $(Agent.ToolsDirectory)/nuget/packages  # NuGet ç¼“å­˜è·¯å¾„
  version: '$(Build.BuildId)'  # ä½¿ç”¨ Build ID ä½œä¸ºç‰ˆæœ¬å·ç¤ºä¾‹

jobs:
- job: BuildAndRelease
  pool:
    name: 'SenparcOpenSource'  # è¿™é‡Œå¡«ä½ çš„è‡ªæ‰˜ç®¡ Agent Pool åç§°
  steps:

    # ğŸŸ¢ ç¼“å­˜ NuGet åŠä¾èµ–é¡¹
    - task: Cache@2
      inputs:
        key: 'nuget | "$(Agent.OS)" | **/*.csproj'  # NuGet ç¼“å­˜ Key
        path: '$(NUGET_PACKAGES)'  # NuGet åŒ…çš„å­˜å‚¨è·¯å¾„
        restoreKeys: 'nuget'
      displayName: 'Cache NuGet Packages'

    # ğŸŸ¢ ç¼“å­˜ Aspire Workload
    - task: Cache@2
      inputs:
        key: 'aspire-workload | "$(Agent.OS)"'
        path: '~/.dotnet'  # .NET SDK åŠ workload ç¼“å­˜ç›®å½•
        restoreKeys: 'aspire-workload'
      displayName: 'Cache Aspire Workload'

    # ğŸŸ¢ ç¼“å­˜ NuGet å·¥å…·ï¼ˆå‡å°‘å®‰è£…æ—¶é—´ï¼‰
    - task: Cache@2
      inputs:
        key: 'nuget-tool | "$(Agent.OS)"'
        path: 'C:\ProgramData\nuget'  # NuGetTool çš„å…¨å±€å­˜å‚¨ä½ç½®
        restoreKeys: 'nuget-tool'
      displayName: 'Cache NuGet Tool'

    # âœ… ä»…å½“ç¼“å­˜æœªå‘½ä¸­æ—¶å®‰è£… Aspire Workload
    - script: |
        dotnet workload list | findstr /C:"aspire" || dotnet workload install aspire
      displayName: 'Check & Install Aspire Workload'
      condition: ne(variables['CACHE_RESTORED'], 'true')

    # âœ… ä½¿ç”¨ç¼“å­˜çš„ NuGet ç‰ˆæœ¬ï¼Œé¿å…é‡å¤å®‰è£…
    - task: NuGetToolInstaller@1
      displayName: 'Use Cached NuGet 6.3.0'
      inputs:
        versionSpec: '6.3.0'

    - script: |  
        nuget sources remove -name nuget.org  
      displayName: 'Remove Existing NuGet Source'

    - script: |  
        dotnet nuget add source https://api.nuget.org/v3/index.json -n nuget.org  
      displayName: 'Add NuGet Source'

    # âœ… æ¢å¤ NuGet ä¾èµ–ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
    - task: NuGetCommand@2
      inputs:
        restoreSolution: '$(solution)'

    # âœ… è§£å†³æ–¹æ¡ˆæ„å»º
    - task: VSBuild@1
      inputs:
        solution: '$(solution)'
        msbuildArgs: '/p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:DesktopBuildPackageLocation="$(build.artifactStagingDirectory)\WebApp.zip" /p:DeployIisAppPath="Default Web Site"'
        platform: 'Any CPU'
        configuration: '$(buildConfiguration)'

    # âœ… æ¢å¤ Template ä¾èµ–
    - task: NuGetCommand@2
      inputs:
        restoreSolution: '$(templateBuild)'

    # âœ… æ„å»º Template è§£å†³æ–¹æ¡ˆ
    - task: VSBuild@1
      inputs:
        solution: '$(templateBuild)'
        msbuildArgs: ''
        platform: 'Any CPU'
        configuration: '$(buildConfiguration)'

    # âœ… æ¨é€ NuGet åŒ…ï¼ˆæ”¯æŒå¤±è´¥ç»§ç»­ï¼‰
    - task: NuGetCommand@2
      displayName: Senparc.Ncf.Template
      inputs:
        command: push
        packagesToPush: '**/Senparc.NCF.Template.*.nupkg'
        nuGetFeedType: external
        publishFeedCredentials: 'nuget-jeffrey-full-key'
      continueOnError: true
      condition: succeededOrFailed()

    # å‘å¸ƒåˆ°ä¸åŒå¹³å°å¹¶åˆ›å»ºå•ä¸€ GitHub Release
    - script: |
        echo Publishing x86 platform
        dotnet publish $(webProject) --configuration $(buildConfiguration) --runtime win-x86 --output $(Build.ArtifactStagingDirectory)/x86

        echo Publishing ARM platform
        dotnet publish $(webProject) --configuration $(buildConfiguration) --runtime linux-arm --output $(Build.ArtifactStagingDirectory)/arm

        echo Publishing macOS platform
        dotnet publish $(webProject) --configuration $(buildConfiguration) --runtime osx-x64 --output $(Build.ArtifactStagingDirectory)/mac

        echo Creating GitHub Release
        gh release create "$(version)" \
          "$(Build.ArtifactStagingDirectory)/x86/*" \
          "$(Build.ArtifactStagingDirectory)/arm/*" \
          "$(Build.ArtifactStagingDirectory)/mac/*" \
          --title "Release $(version)" \
          --notes "Automatic release for version $(version)"
      displayName: 'Publish all Release to GitHub'

    # âœ… å‘å¸ƒæ„å»ºäº§ç‰©
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'sample'